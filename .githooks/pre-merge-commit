#!/bin/bash
#
# Pre-merge-commit hook that generates PROJECT_STRUCTURE.md
# This runs before creating a merge commit

SETUP_QUIET=true SETUP_SH_SKIP_MAIN=1 source ./setup.sh
ensure_eza || {
  echo "[$0] ERROR: Failed to install eza, falling back to tree or find" >&2
}

if command -v eza &> /dev/null; then
  eza \
    --classify \
    --icons \
    --tree \
    --git-ignore \
    --all \
    --ignore-glob 'static|*.vscode|experimental|thoughts/done|docs|.run' \
    . > PROJECT_STRUCTURE.md
elif command -v tree &> /dev/null; then
  echo "[$0] Using tree as fallback for project structure generation"
  tree -a -I '.git|node_modules|__pycache__|*.pyc|.venv|static|experimental|thoughts/done|docs|.run' . > PROJECT_STRUCTURE.md
else
  echo "[$0] Using find as fallback for project structure generation"
  find . -not -path '*/\.git*' -not -path '*/node_modules*' -not -path '*/__pycache__*' -not -name '*.pyc' -not -path '*/.venv*' -not -path '*/static*' -not -path '*/experimental*' -not -path '*/thoughts/done*' -not -path '*/docs*' -not -path '*/.run*' | sort > PROJECT_STRUCTURE.md
fi

exit 0
