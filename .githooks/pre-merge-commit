#!/bin/bash
#
# Pre-merge-commit hook that generates PROJECT_STRUCTURE.md
# This runs before creating a merge commit

# Install eza if not available (for GitHub Actions/Ubuntu)
if ! command -v eza &> /dev/null; then
  echo "eza not found, installing..."

  # Detect OS and install accordingly
  if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # For Ubuntu/Debian (GitHub Actions default)
    # Install using the official repository
    sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
    sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
    sudo apt update
    sudo apt install -y eza
  elif [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    brew install eza
  fi
fi

# Generate project structure using eza
eza \
  --classify \
  --icons \
  --tree \
  --git-ignore \
  --all \
  . > PROJECT_STRUCTURE.md

# Add the generated file to the merge commit
git add PROJECT_STRUCTURE.md

# Exit with 0 to allow the merge to proceed
exit 0
