#!/bin/bash
#
# Pre-commit hook:
# 1. Scans for secrets with gitleaks
# 2. Updates last_updated frontmatter in staged markdown files
# 3. Runs biome lint on staged client files

# --- Gitleaks secret scanning ---
echo "üîç Scanning for secrets with gitleaks..."
if command -v gitleaks >/dev/null 2>&1; then
  if ! gitleaks protect --staged --verbose; then
    echo ""
    echo "‚ùå COMMIT REJECTED: Secrets detected!"
    echo ""
    echo "To fix this:"
    echo "  1. Remove the secrets from your files"
    echo "  2. Add sensitive files to .gitignore"
    echo "  3. Try committing again"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    exit 1
  fi
  echo "‚úÖ No secrets detected"
else
  echo "‚ö†Ô∏è  gitleaks not installed, skipping secret scan"
  echo "   Install with: brew install gitleaks"
fi
echo ""

# --- Frontmatter update for staged .md files ---
staged_md=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)

if [ -n "$staged_md" ]; then
  echo "Updating frontmatter in staged markdown files..."

  timestamp=$(date -u +"%Y-%m-%d %H:%M")

  for file in $staged_md; do
    if [ -f "$file" ]; then
      uv run python3 - "$file" "$timestamp" <<'PY'
import sys
sys.path.insert(0, 'scripts')
import markdown_frontmatter
file_path, timestamp = sys.argv[1], sys.argv[2]
markdown_frontmatter.update(file_path, {'last_updated': timestamp})
print(f"  {file_path}")
PY
      git add "$file"
    fi
  done
fi

# --- Biome lint for staged client files ---
if git diff --cached --name-only | grep -q '^client/'; then
  echo "Running biome lint on staged client files..."
  cd client && DRY_RUN=1 bash scripts/lint.sh
  exit $?
fi

exit 0
