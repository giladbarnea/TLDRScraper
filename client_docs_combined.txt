# TLDRScraper Client Documentation & Code

## README.md

---
last_updated: 2025-11-14 16:24, 722a1a0
---
# TLDRScraper

Newsletter aggregator that scrapes tech newsletters from multiple sources, displays them in a unified interface, and provides AI-powered TLDRs.

## Architecture

- **Frontend**: React 19 + Vite (in `client/`)
- **Backend**: Flask + Python (serverless on Vercel)
- **AI**: OpenAI GPT-5 for TLDRs

See [ARCHITECTURE.md](ARCHITECTURE.md) for detailed flows & user interactions documentation and [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md) for a map of the project structure.

## Development

## Development & Setup

### Running the server and logs watchdog
```bash
# Verify the environment and dependencies are set up correctly.
source ./setup.sh

# Start the server and watchdog in the background. Logs output to file.
start_server_and_watchdog

# Verify the server is running.
print_server_and_watchdog_pids

# Exercise the API with curl requests.
curl http://localhost:5001/api/scrape
curl http://localhost:5001/api/tldr-url
curl ...additional endpoints that may be relevant...

# Stop the server and watchdog.
kill_server_and_watchdog
```


## Client setup

```bash
cd client
npm install
npm run build
npm run dev
```

### Frontend development

For frontend development with hot reload:

```bash
cd client
npm run dev
```

This runs Vite dev server on port 3000 with API proxy to localhost:5000.


### `uv` installation and usage

- Install `uv` and use Python via `uv`:
```bash
source setup.sh
ensure_uv
uv --version
```

## Vercel Deployment

### How It Works

The application is deployed to Vercel as a Python serverless function with a built React frontend:

1. **Build Phase** (`buildCommand` in `vercel.json`):
   - `cd client && npm install && npm run build`
   - Builds React app

2. **Install Phase** (automatic):
   - Vercel auto-detects `requirements.txt`
   - Installs Python dependencies for the serverless function

3. **Runtime**:
   - `/api/index.py` imports the Flask app from `serve.py`
   - All routes (`/`, `/api/*`) are handled by the Python serverless function
   - Flask serves the built React app from `client/static/dist/`
   - API endpoints process requests

### Key Configuration Files

#### `vercel.json`
```json
{
  "buildCommand": "cd client && npm install && npm run build",
  "outputDirectory": "static/dist",
  "rewrites": [
    { "source": "/(.*)", "destination": "/api/index" }
  ]
}
```

- **buildCommand**: Builds the React frontend
- **outputDirectory**: Points to where React builds output (matches `client/vite.config.js` outDir)
- **rewrites**: Routes all requests to the Python serverless function

#### `api/index.py`
```python
import sys
import os

# Add parent directory to path so we can import serve.py and other modules
parent_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
if parent_dir not in sys.path:
    sys.path.insert(0, parent_dir)

from serve import app as app
```

This is the Vercel serverless function entry point. The path manipulation is required because Vercel's Python runtime doesn't automatically add the parent directory to `sys.path`.

#### `serve.py`
```python
# Configure Flask to serve React build output
app = Flask(
    __name__,
    static_folder='static/dist/assets',
    static_url_path='/assets'
)

@app.route("/")
def index():
    """Serve the React app"""
    static_dist = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'static', 'dist')
    return send_from_directory(static_dist, 'index.html')
```

Flask is configured to:
- Serve static assets from `static/dist/assets` at `/assets/*`
- Serve the React app's `index.html` at the root `/`
- Handle API routes at `/api/*`

### Deployment Requirements

1. **React build output** must be in `client/static/dist/` (configured in `client/vite.config.js`)
2. **Python dependencies** are managed by `uv` and must manually be added to `requirements.txt` (Vercel auto-installs)
3. **Module imports** in `api/index.py` must handle parent directory path
4. **Flask static configuration** must point to built React assets

### Common Vercel Deployment Issues

**Issue**: `pip: command not found`
- **Cause**: Explicit `installCommand` in vercel.json trying to run pip in Node.js context
- **Solution**: Remove `installCommand` - Vercel auto-installs from requirements.txt

**Issue**: `No Output Directory named "public" found`
- **Cause**: Vercel looking for default output directory
- **Solution**: Add `"outputDirectory": "static/dist"` to vercel.json

**Issue**: `404 for /api/index`
- **Cause**: Python module import failing in serverless function
- **Solution**: Add parent directory to sys.path in api/index.py

## Documentation

- [ARCHITECTURE.md](ARCHITECTURE.md) - Detailed flows & user interactions documentation
- [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md) - Map of the project structure
- [GOTCHAS.md](GOTCHAS.md) - Documented solved tricky past bugs
- [BUGS.md](BUGS.md) - Known issues

# Client Source Code

{
  "content": "<files>\n<file path=\"client/index.html\">\n<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    <meta name=\"color-scheme\" content=\"light\" />\n    <title>Newsletter Aggregator</title>\n\n    <!-- Vollkorn font for reading surface -->\n    <link rel=\"preconnect\" href=\"https://fonts.googleapis.com\" crossorigin>\n    <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>\n    <link href=\"https://fonts.googleapis.com/css2?family=Vollkorn:wght@400;700&display=swap\" rel=\"stylesheet\">\n  </head>\n  <body>\n    <div id=\"root\"></div>\n    <script type=\"module\" src=\"/src/main.jsx\"></script>\n  </body>\n</html>\n\n</file>\n<file path=\"client/postcss.config.js\">\nexport default {\n  plugins: {\n    '@tailwindcss/postcss': {},\n    autoprefixer: {},\n  },\n}\n\n</file>\n<file path=\"client/src/App.jsx\">\nimport { Calendar, RefreshCw, Settings, Zap } from 'lucide-react'\nimport { useEffect, useState } from 'react'\nimport Feed from './components/Feed'\nimport ScrapeForm from './components/ScrapeForm'\nimport { loadFromCache } from './lib/scraper'\n\nfunction App() {\n  const [results, setResults] = useState(null)\n  const [scrolled, setScrolled] = useState(false)\n  const [showSettings, setShowSettings] = useState(false)\n\n  useEffect(() => {\n    const handleScroll = () => setScrolled(window.scrollY > 10)\n    window.addEventListener('scroll', handleScroll)\n    return () => window.removeEventListener('scroll', handleScroll)\n  }, [])\n\n  useEffect(() => {\n    const today = new Date()\n    const threeDaysAgo = new Date(today)\n    threeDaysAgo.setDate(today.getDate() - 3)\n\n    const endDate = today.toISOString().split('T')[0]\n    const startDate = threeDaysAgo.toISOString().split('T')[0]\n\n    loadFromCache(startDate, endDate)\n      .then(cached => {\n        if (cached) {\n          setResults(cached)\n        } else {\n          setResults({ payloads: [], stats: null })\n        }\n      })\n      .catch(err => {\n        console.error('Failed to load cached results:', err)\n      })\n  }, [])\n\n  const currentDate = new Date().toLocaleDateString('en-US', {\n    weekday: 'long',\n    month: 'long',\n    day: 'numeric'\n  })\n\n  return (\n    <div className=\"min-h-screen flex justify-center font-sans bg-[#f8fafc] text-slate-900 selection:bg-brand-100 selection:text-brand-900\">\n      <div className=\"w-full max-w-3xl relative\">\n\n        {/* Header */}\n        <header\n          className={`\n            relative z-40 px-6 py-6 transition-all duration-300 ease-out\n            ${scrolled ? 'bg-white/90 backdrop-blur-md border-b border-slate-100 shadow-sm' : 'bg-transparent'}\n          `}\n        >\n          <div className=\"flex justify-between items-center\">\n            <div>\n              <h1 className=\"font-display text-3xl font-extrabold tracking-tight text-slate-900\">\n                TLDR<span className=\"text-brand-500\">.</span>\n              </h1>\n              <p className={`text-sm font-medium text-slate-500 transition-all duration-300 ${scrolled ? 'h-0 opacity-0 overflow-hidden' : 'h-auto opacity-100 mt-1'}`}>\n                {currentDate}\n              </p>\n            </div>\n\n            <div className=\"flex gap-2\">\n               <button\n                onClick={() => setShowSettings(!showSettings)}\n                className={`group flex items-center justify-center w-10 h-10 rounded-full transition-all duration-300 ${showSettings ? 'bg-brand-50 text-brand-600' : 'hover:bg-white hover:shadow-md text-slate-400'}`}\n                title=\"Date Range & Settings\"\n              >\n                <Calendar size={18} className=\"transition-colors\" />\n              </button>\n            </div>\n          </div>\n\n          {/* Settings / Scrape Form Area */}\n          <div className={`\n              overflow-hidden transition-all duration-500 ease-in-out\n              ${showSettings ? 'max-h-[400px] opacity-100 mt-4' : 'max-h-0 opacity-0'}\n          `}>\n             <div className=\"bg-white rounded-2xl p-6 shadow-lg border border-slate-100\">\n                <ScrapeForm onResults={(res) => { setResults(res); setShowSettings(false); }} />\n             </div>\n          </div>\n        </header>\n\n        {/* Minimalist Ticker (Insight) */}\n        <div className={`\n            px-6 mb-8 transition-all duration-500 ease-in-out\n            ${scrolled ? 'opacity-0 h-0 -mt-4 overflow-hidden' : 'opacity-100 h-auto'}\n        `}>\n          {results?.stats && (\n             <div className=\"bg-white rounded-2xl p-4 shadow-soft border border-slate-50 flex items-start gap-3 animate-fade-in\">\n               <div className=\"mt-1 bg-brand-50 p-1.5 rounded-lg\">\n                 <Zap size={16} className=\"text-brand-600\" />\n               </div>\n               <p className=\"text-sm text-slate-600 font-medium leading-relaxed\">\n                 <span className=\"font-bold text-slate-900\">Daily Update:</span>\n                 {' '}Synced <span className=\"text-brand-600 font-bold\">{results.stats.total_articles}</span> articles across {results.stats.dates_processed} days.\n                 {results.stats.unique_urls > 0 && <span> ({results.stats.unique_urls} unique).</span>}\n               </p>\n             </div>\n          )}\n        </div>\n\n        {/* Main Content */}\n        <main className=\"px-6\">\n          {!results ? (\n             <div className=\"flex flex-col items-center justify-center py-32 opacity-50 animate-pulse\">\n                <div className=\"w-12 h-12 bg-slate-200 rounded-full mb-4\"></div>\n                <div className=\"h-4 w-32 bg-slate-200 rounded mb-2\"></div>\n                <div className=\"h-3 w-24 bg-slate-100 rounded\"></div>\n             </div>\n          ) : (results.payloads && results.payloads.length > 0) ? (\n            <Feed payloads={results.payloads} />\n          ) : (\n            <div className=\"flex flex-col items-center justify-center py-32 text-slate-400\">\n               <p>No newsletters found for this period.</p>\n               <button onClick={() => setShowSettings(true)} className=\"mt-4 text-brand-600 font-medium hover:underline\">\n                 Open settings to scrape\n               </button>\n            </div>\n          )}\n        </main>\n\n      </div>\n    </div>\n  )\n}\n\nexport default App\n\n</file>\n<file path=\"client/src/components/ArticleCard.jsx\">\nimport { Bot, CheckCircle, Loader2, Minus, Sparkles, Trash2 } from 'lucide-react'\nimport { useMemo, useState } from 'react'\nimport { useArticleState } from '../hooks/useArticleState'\nimport { useSummary } from '../hooks/useSummary'\n\nfunction ArticleCard({ article, index }) {\n  const { isRead, isRemoved, toggleRead, toggleRemove, markTldrHidden, unmarkTldrHidden, loading: stateLoading } = useArticleState(\n    article.issueDate,\n    article.url\n  )\n  const tldr = useSummary(article.issueDate, article.url, 'tldr')\n\n  const fullUrl = useMemo(() => {\n    const url = article.url\n    if (url.startsWith('http://') || url.startsWith('https://')) return url\n    return `https://${url}`\n  }, [article.url])\n\n  const handleExpand = async (e) => {\n    e.stopPropagation();\n    if (isRemoved) return;\n\n    const wasExpanded = tldr.expanded\n    tldr.toggle()\n\n    if (!isRead && !tldr.expanded) {\n       toggleRead()\n    }\n     if (wasExpanded && !tldr.expanded) {\n      markTldrHidden()\n    } else if (tldr.expanded) {\n      unmarkTldrHidden()\n    }\n  };\n\n  const handleRemove = (e) => {\n    e.stopPropagation();\n    if (!isRemoved && tldr.expanded) tldr.collapse();\n    toggleRemove();\n  };\n\n  const handleCardClick = (e) => {\n    if (isRemoved) {\n      e.preventDefault();\n      toggleRemove();\n    }\n  };\n\n  return (\n    <div\n      onClick={handleCardClick}\n      className={`\n        group relative transition-all duration-300 ease-out\n        rounded-[20px] border\n        ${isRemoved\n          ? 'opacity-50 grayscale scale-[0.98] bg-slate-50 border-transparent cursor-pointer hover:opacity-60'\n          : 'bg-white/80 backdrop-blur-xl border-white/40 shadow-[0_2px_12px_-4px_rgba(0,0,0,0.05)] hover:shadow-[0_8px_20px_-4px_rgba(0,0,0,0.08)] hover:-translate-y-0.5'}\n        ${tldr.expanded ? 'mb-6 ring-1 ring-brand-100 shadow-md bg-white' : 'mb-3'}\n      `}\n    >\n      <div className=\"p-5 flex flex-col gap-3\">\n         {/* Title */}\n         <a\n           href={isRemoved ? undefined : fullUrl}\n           target={isRemoved ? undefined : \"_blank\"}\n           rel={isRemoved ? undefined : \"noopener noreferrer\"}\n           className={`\n             text-[17px] font-display font-semibold leading-snug text-slate-900\n             group-hover:text-brand-600 transition-colors duration-200 block tracking-tight\n             ${isRead ? 'text-slate-500 font-normal' : ''}\n             ${isRemoved ? 'pointer-events-none' : ''}\n           `}\n           onClick={(e) => {\n             if (isRemoved) {\n               e.preventDefault();\n               return;\n             }\n             if (!isRead) toggleRead();\n           }}\n         >\n           {article.title}\n         </a>\n\n         {/* Header */}\n         {!isRemoved && (\n           <div className=\"mb-1\">\n               <span className=\"text-[11px] font-medium text-slate-400\">\n                  {article.articleMeta || 'Today'}\n               </span>\n               {isRead && <CheckCircle size={14} className=\"text-slate-300 inline ml-2\" />}\n           </div>\n         )}\n\n         {/* Actions */}\n         {!isRemoved && (\n           <div className=\"flex items-center justify-between pt-1\">\n              <button\n                onClick={handleExpand}\n                disabled={tldr.loading}\n                className={`\n                  flex items-center gap-2 px-4 py-1.5 rounded-full text-[11px] font-semibold tracking-wide transition-all duration-200\n                  ${tldr.expanded\n                    ? 'bg-slate-100 text-slate-600 hover:bg-slate-200'\n                    : 'bg-slate-50 text-slate-600 hover:bg-brand-50 hover:text-brand-600'}\n                `}\n              >\n                 {tldr.loading ? <Loader2 size={12} className=\"animate-spin\" /> :\n                  tldr.expanded ? <><Minus size={12} /> Close Summary</> : <><Sparkles size={12} /> TLDR</>\n                 }\n              </button>\n\n              <div className=\"flex gap-2\">\n                  <button onClick={handleRemove} className=\"p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors\">\n                     <Trash2 size={14} />\n                  </button>\n              </div>\n           </div>\n         )}\n\n         {/* TLDR Content */}\n         {!isRemoved && (\n           <div\n              className={`\n                transition-all duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1.0)]\n                ${tldr.expanded && tldr.html ? 'opacity-100 mt-4 border-t border-slate-100 pt-5' : 'max-h-0 opacity-0 overflow-hidden -mt-3'}\n              `}\n           >\n              {/* -mt-3 cancels parent's gap-3 to eliminate spacing when collapsed */}\n              {tldr.status === 'error' ? (\n                 <div className=\"text-xs text-red-500 bg-red-50 p-3 rounded-lg\">{tldr.errorMessage || 'Failed to load summary.'}</div>\n              ) : (\n                 <div className=\"animate-fade-in\">\n                    <div className=\"flex items-center gap-2 mb-4\">\n                      <Bot size={16} className=\"text-brand-500\" />\n                      <span className=\"text-[11px] font-bold uppercase tracking-widest text-slate-500\">Gemini Insight</span>\n                    </div>\n                    <div\n                      className=\"prose prose-sm prose-slate max-w-none font-sans text-slate-600 leading-relaxed text-[15px] prose-p:my-2\"\n                      dangerouslySetInnerHTML={{ __html: tldr.html }}\n                    />\n                 </div>\n              )}\n           </div>\n         )}\n      </div>\n    </div>\n  )\n}\n\nexport default ArticleCard\n\n</file>\n<file path=\"client/src/components/ArticleList.jsx\">\nimport { useMemo } from 'react'\nimport ArticleCard from './ArticleCard'\n\nfunction ArticleList({ articles }) {\n  const sortedArticles = useMemo(() => {\n    return [...articles].sort((a, b) => {\n      const stateA = a.removed ? 1 : 0\n      const stateB = b.removed ? 1 : 0\n\n      if (stateA !== stateB) return stateA - stateB\n\n      return (a.originalOrder ?? 0) - (b.originalOrder ?? 0)\n    })\n  }, [articles])\n\n  const sectionsWithArticles = useMemo(() => {\n    const sections = []\n    let currentSection = null\n\n    sortedArticles.forEach((article, index) => {\n      const sectionTitle = article.section\n      const sectionEmoji = article.sectionEmoji\n      const sectionKey = sectionTitle ? `${sectionEmoji || ''} ${sectionTitle}`.trim() : null\n\n      if (sectionKey && sectionKey !== currentSection) {\n        sections.push({\n          type: 'section',\n          key: sectionKey,\n          label: sectionKey\n        })\n        currentSection = sectionKey\n      } else if (!sectionTitle && currentSection !== null) {\n        currentSection = null\n      }\n\n      sections.push({\n        type: 'article',\n        key: article.url,\n        article,\n        index\n      })\n    })\n\n    return sections\n  }, [sortedArticles])\n\n  return (\n    <div className=\"space-y-4\">\n      {sectionsWithArticles.map((item) => (\n        item.type === 'section' ? (\n          <div key={item.key} className=\"pt-6 pb-2\">\n            <h4 className=\"text-sm font-bold uppercase tracking-widest text-slate-400 ml-1\">\n              {item.label}\n            </h4>\n          </div>\n        ) : (\n          <ArticleCard\n            key={item.key}\n            article={item.article}\n            index={item.index}\n          />\n        )\n      ))}\n    </div>\n  )\n}\n\nexport default ArticleList\n\n</file>\n<file path=\"client/src/components/CacheToggle.jsx\">\nimport { useSupabaseStorage } from '../hooks/useSupabaseStorage'\nimport './CacheToggle.css'\n\nfunction CacheToggle() {\n  const [enabled, setEnabled, , { loading }] = useSupabaseStorage('cache:enabled', true)\n\n  return (\n    <div className=\"cache-toggle-container\" data-testid=\"cache-toggle-container\">\n      <label className=\"cache-toggle-label\" htmlFor=\"cacheToggle\">\n        <input\n          id=\"cacheToggle\"\n          type=\"checkbox\"\n          className=\"cache-toggle-input\"\n          data-testid=\"cache-toggle-input\"\n          aria-label=\"Enable cache\"\n          checked={enabled}\n          disabled={loading}\n          onChange={(e) => setEnabled(e.target.checked)}\n        />\n        <span className=\"cache-toggle-checkbox\" data-testid=\"cache-toggle-switch\" />\n        <span className=\"cache-toggle-text\">Cache</span>\n        <span className=\"cache-toggle-status\" data-testid=\"cache-toggle-status\">\n          {enabled ? '(enabled)' : '(disabled)'}\n        </span>\n      </label>\n    </div>\n  )\n}\n\nexport default CacheToggle\n\n</file>\n<file path=\"client/src/components/Feed.jsx\">\nimport { useSupabaseStorage } from '../hooks/useSupabaseStorage'\nimport { getNewsletterScrapeKey } from '../lib/storageKeys'\nimport ArticleList from './ArticleList'\n\nfunction Feed({ payloads }) {\n  return (\n    <div className=\"space-y-16 pb-32\">\n      {payloads.map((payload) => (\n        <DailyGroup key={payload.date} payload={payload} />\n      ))}\n    </div>\n  )\n}\n\nfunction DailyGroup({ payload }) {\n  const [livePayload, , , { loading }] = useSupabaseStorage(\n    getNewsletterScrapeKey(payload.date),\n    payload\n  )\n\n  const date = livePayload?.date ?? payload.date\n  const articles = (livePayload?.articles ?? payload.articles).map((article, index) => ({\n    ...article,\n    originalOrder: index\n  }))\n  const issues = livePayload?.issues ?? payload.issues ?? []\n\n  const dateObj = new Date(date)\n  const niceDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })\n  const isToday = new Date().toDateString() === dateObj.toDateString()\n\n  return (\n    <section className=\"animate-slide-up\">\n      <div className=\"sticky top-0 z-30 bg-slate-50/95 backdrop-blur-sm py-4 mb-6 border-b border-slate-200/60\">\n        <div className=\"flex items-baseline gap-3\">\n          <h2 className=\"font-display text-2xl font-bold text-slate-900 tracking-tight\">\n            {isToday ? 'Today' : niceDate}\n          </h2>\n          {loading && <span className=\"text-xs font-medium text-brand-500 animate-pulse\">Syncing...</span>}\n        </div>\n      </div>\n\n      <div className=\"space-y-12\">\n        {issues.map((issue) => {\n          const categoryArticles = articles.filter((article) => article.category === issue.category)\n          const allRemoved = categoryArticles.length > 0 && categoryArticles.every((article) => article.removed)\n\n          return (\n            <div key={`${date}-${issue.category}`} className=\"space-y-6\">\n              <div className={`flex items-center gap-3 pl-1 border-l-2 transition-all duration-300 ${allRemoved ? 'border-slate-200 opacity-50' : 'border-brand-200'}`}>\n                <h3 className={`font-display font-bold text-lg pl-3 transition-all duration-300 ${allRemoved ? 'text-slate-400 line-through decoration-2' : 'text-slate-800'}`}>\n                  {issue.category}\n                </h3>\n              </div>\n\n              {(issue.title || issue.subtitle) && (\n                <div className={`p-4 rounded-xl border mx-1 transition-all duration-300 ${allRemoved ? 'bg-slate-50 border-slate-200 opacity-50' : 'bg-white border-slate-100 shadow-sm'}`}>\n                  {issue.title && <div className={`font-semibold transition-all duration-300 ${allRemoved ? 'text-slate-400 line-through decoration-2' : 'text-slate-900'}`}>{issue.title}</div>}\n                  {issue.subtitle && issue.subtitle !== issue.title && (\n                    <div className={`text-sm mt-1 transition-all duration-300 ${allRemoved ? 'text-slate-300 line-through decoration-2' : 'text-slate-500'}`}>{issue.subtitle}</div>\n                  )}\n                </div>\n              )}\n\n              <ArticleList\n                articles={categoryArticles}\n              />\n            </div>\n          )\n        })}\n\n        {articles.some((article) => !article.category) && (\n           <div className=\"space-y-6\">\n              <div className=\"pl-4 border-l-2 border-slate-200\">\n                 <h3 className=\"font-display font-bold text-lg text-slate-400\">Other</h3>\n              </div>\n              <ArticleList articles={articles.filter((article) => !article.category)} />\n           </div>\n        )}\n      </div>\n    </section>\n  )\n}\n\nexport default Feed\n\n</file>\n<file path=\"client/src/components/ResultsDisplay.jsx\">\nimport { useSupabaseStorage } from '../hooks/useSupabaseStorage'\nimport { getNewsletterScrapeKey } from '../lib/storageKeys'\nimport ArticleList from './ArticleList'\nimport './ResultsDisplay.css'\n\nfunction ResultsDisplay({ results }) {\n  return (\n    <div id=\"result\" className=\"result success\">\n      {/* Prominent Stats Section */}\n      <div className=\"bg-white rounded-2xl p-6 shadow-soft border border-slate-100 mb-8\">\n        <div className=\"grid grid-cols-3 gap-6\">\n          <div>\n            <div className=\"text-sm font-medium text-slate-500 uppercase tracking-wider\">\n              Articles\n            </div>\n            <div className=\"text-2xl font-bold text-slate-900 mt-1\">\n              {results.stats.total_articles}\n            </div>\n          </div>\n          <div>\n            <div className=\"text-sm font-medium text-slate-500 uppercase tracking-wider\">\n              Unique URLs\n            </div>\n            <div className=\"text-2xl font-bold text-slate-900 mt-1\">\n              {results.stats.unique_urls}\n            </div>\n          </div>\n          <div>\n            <div className=\"text-sm font-medium text-slate-500 uppercase tracking-wider\">\n              Dates\n            </div>\n            <div className=\"text-2xl font-bold text-slate-900 mt-1\">\n              {results.stats.dates_with_content}/{results.stats.dates_processed}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <main id=\"write\">\n        {(results.payloads || []).map((payload) => (\n          <DailyResults\n            key={payload.date}\n            payload={payload}\n          />\n        ))}\n      </main>\n    </div>\n  )\n}\n\nfunction DailyResults({ payload }) {\n  const [livePayload, , , { loading }] = useSupabaseStorage(\n    getNewsletterScrapeKey(payload.date),\n    payload\n  )\n\n  const date = livePayload?.date ?? payload.date\n  const articles = (livePayload?.articles ?? payload.articles).map((article, index) => ({\n    ...article,\n    originalOrder: index\n  }))\n  const issues = livePayload?.issues ?? payload.issues ?? []\n\n  return (\n    <div className=\"date-group\">\n      <div className=\"date-header-container\" data-date={date}>\n        <h2>{date}</h2>\n        {loading && <span className=\"loading-indicator\"> (loading...)</span>}\n      </div>\n\n      {issues.map((issue) => (\n        <div\n          key={`${date}-${issue.category}`}\n          className=\"issue-section\"\n        >\n          <div className=\"issue-header-container\">\n            <h4>{issue.category}</h4>\n          </div>\n\n          {(issue.title || issue.subtitle) && (\n            <div className=\"issue-title-block\">\n              {issue.title && (\n                <div className=\"issue-title-line\">{issue.title}</div>\n              )}\n              {issue.subtitle && issue.subtitle !== issue.title && (\n                <div className=\"issue-title-line\">{issue.subtitle}</div>\n              )}\n            </div>\n          )}\n\n          <ArticleList\n            articles={articles.filter((article) => article.category === issue.category)}\n          />\n        </div>\n      ))}\n\n      {articles.some((article) => !article.category) && (\n        <ArticleList\n          articles={articles.filter((article) => !article.category)}\n        />\n      )}\n    </div>\n  )\n}\n\nexport default ResultsDisplay\n\n</file>\n<file path=\"client/src/components/ScrapeForm.jsx\">\nimport { AlertCircle, ArrowRight, Loader2 } from 'lucide-react'\nimport { useActionState, useEffect, useState } from 'react'\nimport { useSupabaseStorage } from '../hooks/useSupabaseStorage'\nimport { scrapeNewsletters } from '../lib/scraper'\n\nfunction ScrapeForm({ onResults }) {\n  const [startDate, setStartDate] = useState('')\n  const [endDate, setEndDate] = useState('')\n  const [cacheEnabled] = useSupabaseStorage('cache:enabled', true)\n  const [progress, setProgress] = useState(0)\n\n  useEffect(() => {\n    const today = new Date()\n    const threeDaysAgo = new Date(today)\n    threeDaysAgo.setDate(today.getDate() - 3)\n    setEndDate(today.toISOString().split('T')[0])\n    setStartDate(threeDaysAgo.toISOString().split('T')[0])\n  }, [])\n\n  const [state, formAction, isPending] = useActionState(\n    async (previousState, formData) => {\n      const start = formData.get('start_date')\n      const end = formData.get('end_date')\n\n      const startDateObj = new Date(start)\n      const endDateObj = new Date(end)\n      const daysDiff = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24))\n\n      if (startDateObj > endDateObj) {\n        return { error: 'Start date must be before or equal to end date.' }\n      }\n      if (daysDiff >= 31) {\n        return { error: 'Date range cannot exceed 31 days.' }\n      }\n\n      setProgress(10)\n      const interval = setInterval(() => {\n         setProgress(prev => Math.min(prev + 5, 90))\n      }, 500)\n\n      try {\n        const results = await scrapeNewsletters(start, end, cacheEnabled)\n        clearInterval(interval)\n        setProgress(100)\n        onResults(results)\n        return { success: true }\n      } catch (err) {\n        clearInterval(interval)\n        setProgress(0)\n        return { error: err.message || 'Network error' }\n      }\n    },\n    { success: false }\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n         <h3 className=\"font-display font-bold text-lg text-slate-900\">Sync Settings</h3>\n         <div className=\"text-xs font-medium text-brand-600 bg-brand-50 px-3 py-1 rounded-full\">\n            {cacheEnabled ? 'Cache Active' : 'Live Mode'}\n         </div>\n      </div>\n\n      <form action={formAction} className=\"space-y-5\">\n        <div className=\"grid grid-cols-2 gap-4\">\n          <div className=\"space-y-2\">\n            <label htmlFor=\"start_date\" className=\"block text-xs font-bold uppercase tracking-wider text-slate-500\">Start Date</label>\n            <input\n              id=\"start_date\"\n              name=\"start_date\"\n              type=\"date\"\n              value={startDate}\n              onChange={(e) => setStartDate(e.target.value)}\n              required\n              className=\"w-full bg-slate-50 border-0 rounded-lg px-4 py-3 text-slate-900 font-medium focus:ring-2 focus:ring-brand-500 transition-shadow\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <label htmlFor=\"end_date\" className=\"block text-xs font-bold uppercase tracking-wider text-slate-500\">End Date</label>\n            <input\n              id=\"end_date\"\n              name=\"end_date\"\n              type=\"date\"\n              value={endDate}\n              onChange={(e) => setEndDate(e.target.value)}\n              required\n              className=\"w-full bg-slate-50 border-0 rounded-lg px-4 py-3 text-slate-900 font-medium focus:ring-2 focus:ring-brand-500 transition-shadow\"\n            />\n          </div>\n        </div>\n\n        <button\n          type=\"submit\"\n          disabled={isPending}\n          className={`\n             w-full py-4 rounded-xl font-bold tracking-wide text-sm flex items-center justify-center gap-2 transition-all duration-200\n             ${isPending\n               ? 'bg-slate-100 text-slate-400 cursor-not-allowed'\n               : 'bg-slate-900 text-white hover:bg-brand-600 hover:shadow-lg hover:shadow-brand-500/30'}\n          `}\n        >\n          {isPending ? (\n            <>\n              <Loader2 className=\"animate-spin\" size={18} />\n              <span>Syncing... {progress}%</span>\n            </>\n          ) : (\n            <>\n              <span>Update Feed</span>\n              <ArrowRight size={18} />\n            </>\n          )}\n        </button>\n\n        {isPending && (\n           <div className=\"h-1 w-full bg-slate-100 rounded-full overflow-hidden\">\n              <div\n                 className=\"h-full bg-brand-500 transition-all duration-500 ease-out\"\n                 style={{ width: `${progress}%` }}\n              />\n           </div>\n        )}\n      </form>\n\n      {state.error && (\n        <div className=\"flex items-start gap-3 p-4 bg-red-50 text-red-600 rounded-xl text-sm\">\n           <AlertCircle size={18} className=\"shrink-0 mt-0.5\" />\n           <p>{state.error}</p>\n        </div>\n      )}\n    </div>\n  )\n}\n\nexport default ScrapeForm\n\n</file>\n<file path=\"client/src/hooks/useArticleState.js\">\nimport { useCallback, useMemo } from 'react'\nimport { getNewsletterScrapeKey } from '../lib/storageKeys'\nimport { useSupabaseStorage } from './useSupabaseStorage'\n\nexport function useArticleState(date, url) {\n  const storageKey = getNewsletterScrapeKey(date)\n  const [payload, setPayload, , { loading, error }] = useSupabaseStorage(storageKey, null)\n\n  const article = useMemo(() => {\n    return payload?.articles?.find(a => a.url === url) || null\n  }, [payload, url])\n\n  const isRead = article?.read?.isRead ?? false\n  const isRemoved = Boolean(article?.removed)\n  const isTldrHidden = Boolean(article?.tldrHidden)\n\n  const state = !article ? 0\n    : article.removed ? 3\n    : article.tldrHidden ? 2\n    : article.read?.isRead ? 1\n    : 0\n\n  const updateArticle = useCallback((updater) => {\n    if (!article) return\n\n    setPayload(current => {\n      if (!current) return current\n\n      return {\n        ...current,\n        articles: current.articles.map(a =>\n          a.url === url ? { ...a, ...updater(a) } : a\n        )\n      }\n    })\n  }, [article, url, setPayload])\n\n  const markAsRead = useCallback(() => {\n    updateArticle(() => ({\n      read: { isRead: true, markedAt: new Date().toISOString() }\n    }))\n  }, [updateArticle])\n\n  const markAsUnread = useCallback(() => {\n    updateArticle(() => ({\n      read: { isRead: false, markedAt: null }\n    }))\n  }, [updateArticle])\n\n  const toggleRead = useCallback(() => {\n    if (isRead) markAsUnread()\n    else markAsRead()\n  }, [isRead, markAsRead, markAsUnread])\n\n  const setRemoved = useCallback((removed) => {\n    updateArticle(() => ({ removed: Boolean(removed) }))\n  }, [updateArticle])\n\n  const toggleRemove = useCallback(() => {\n    setRemoved(!isRemoved)\n  }, [isRemoved, setRemoved])\n\n  const setTldrHidden = useCallback((hidden) => {\n    updateArticle(() => ({ tldrHidden: Boolean(hidden) }))\n  }, [updateArticle])\n\n  const markTldrHidden = useCallback(() => {\n    setTldrHidden(true)\n  }, [setTldrHidden])\n\n  const unmarkTldrHidden = useCallback(() => {\n    setTldrHidden(false)\n  }, [setTldrHidden])\n\n  return {\n    article,\n    isRead,\n    isRemoved,\n    isTldrHidden,\n    state,\n    loading,\n    error,\n    markAsRead,\n    markAsUnread,\n    toggleRead,\n    setRemoved,\n    toggleRemove,\n    setTldrHidden,\n    markTldrHidden,\n    unmarkTldrHidden,\n    updateArticle\n  }\n}\n\n</file>\n<file path=\"client/src/hooks/useSummary.js\">\nimport DOMPurify from 'dompurify'\nimport { marked } from 'marked'\nimport { useCallback, useMemo, useState } from 'react'\nimport { useArticleState } from './useArticleState'\n\nexport function useSummary(date, url, type = 'tldr') {\n  if (type === 'summary') {\n    throw new Error('Summary feature has been removed. Use type=\"tldr\" instead.')\n  }\n\n  const { article, updateArticle } = useArticleState(date, url)\n  const [loading, setLoading] = useState(false)\n  const [expanded, setExpanded] = useState(false)\n  const [effort, setEffort] = useState('low')\n\n  const data = article?.[type]\n  const status = data?.status || 'unknown'\n  const markdown = data?.markdown || ''\n\n  const html = useMemo(() => {\n    if (!markdown) return ''\n    try {\n      const rawHtml = marked.parse(markdown)\n      return DOMPurify.sanitize(rawHtml)\n    } catch (error) {\n      console.error('Failed to parse markdown:', error)\n      return ''\n    }\n  }, [markdown])\n\n  const errorMessage = data?.errorMessage || null\n  const isAvailable = status === 'available' && markdown\n  const isLoading = status === 'creating' || loading\n  const isError = status === 'error'\n\n  const buttonLabel = useMemo(() => {\n    if (isLoading) return 'Loading...'\n    if (expanded) return 'Hide'\n    if (isAvailable) return 'Available'\n    if (isError) return 'Retry'\n    return 'TLDR'\n  }, [isLoading, expanded, isAvailable, isError, type])\n\n  const fetch = useCallback(async (summaryEffort = effort) => {\n    if (!article) return\n\n    setLoading(true)\n    setEffort(summaryEffort)\n\n    const endpoint = '/api/tldr-url'\n\n    try {\n      const response = await window.fetch(endpoint, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          url,\n          summary_effort: summaryEffort\n        })\n      })\n\n      const result = await response.json()\n\n      if (result.success) {\n        updateArticle(() => ({\n          [type]: {\n            status: 'available',\n            markdown: result[`${type}_markdown`] || '',\n            effort: summaryEffort,\n            checkedAt: new Date().toISOString(),\n            errorMessage: null\n          }\n        }))\n        setExpanded(true)\n      } else {\n        updateArticle((current) => ({\n          [type]: {\n            ...(current[type] || {}),\n            status: 'error',\n            errorMessage: result.error || `Failed to fetch ${type}`\n          }\n        }))\n      }\n    } catch (error) {\n      updateArticle((current) => ({\n        [type]: {\n          ...(current[type] || {}),\n          status: 'error',\n          errorMessage: error.message || 'Network error'\n        }\n      }))\n      console.error(`Failed to fetch ${type}:`, error)\n    } finally {\n      setLoading(false)\n    }\n  }, [article, url, type, effort, updateArticle])\n\n  const toggle = useCallback((summaryEffort) => {\n    if (isAvailable) {\n      setExpanded(!expanded)\n    } else {\n      fetch(summaryEffort)\n    }\n  }, [isAvailable, expanded, fetch])\n\n  const collapse = useCallback(() => {\n    setExpanded(false)\n  }, [])\n\n  const expand = useCallback(() => {\n    setExpanded(true)\n  }, [])\n\n  return {\n    data,\n    status,\n    markdown,\n    html,\n    errorMessage,\n    loading: isLoading,\n    expanded,\n    effort,\n    isAvailable,\n    isError,\n    buttonLabel,\n    fetch,\n    toggle,\n    collapse,\n    expand\n  }\n}\n\n</file>\n<file path=\"client/src/hooks/useSupabaseStorage.js\">\nimport { useCallback, useEffect, useRef, useState } from 'react'\n\nconst changeListenersByKey = new Map()\nconst readCache = new Map()\nconst inflightReads = new Map()\n\nfunction emitChange(key) {\n  const listeners = changeListenersByKey.get(key)\n  if (listeners) {\n    listeners.forEach(listener => {\n      try {\n        listener()\n      } catch (error) {\n        console.error(`Storage listener failed: ${error.message}`)\n      }\n    })\n  }\n\n  if (typeof window !== 'undefined') {\n    window.dispatchEvent(new CustomEvent('supabase-storage-change', { detail: { key } }))\n  }\n}\n\nfunction subscribe(key, listener) {\n  if (!changeListenersByKey.has(key)) {\n    changeListenersByKey.set(key, new Set())\n  }\n  changeListenersByKey.get(key).add(listener)\n\n  return () => {\n    const listeners = changeListenersByKey.get(key)\n    if (listeners) {\n      listeners.delete(listener)\n      if (listeners.size === 0) {\n        changeListenersByKey.delete(key)\n      }\n    }\n  }\n}\n\nasync function readValue(key, defaultValue) {\n  if (typeof window === 'undefined') return defaultValue\n\n  if (readCache.has(key)) {\n    return readCache.get(key)\n  }\n\n  if (inflightReads.has(key)) {\n    return inflightReads.get(key)\n  }\n\n  const readPromise = (async () => {\n    try {\n      let value = defaultValue\n\n      if (key.startsWith('cache:')) {\n        const response = await window.fetch(`/api/storage/setting/${key}`)\n        const data = await response.json()\n        if (data.success) {\n          value = data.value\n        }\n      } else if (key.startsWith('newsletters:scrapes:')) {\n        const date = key.split(':')[2]\n        const response = await window.fetch(`/api/storage/daily/${date}`)\n        const data = await response.json()\n        if (data.success) {\n          value = data.payload\n        }\n      } else {\n        console.warn(`Unknown storage key pattern: ${key}`)\n      }\n\n      readCache.set(key, value)\n      return value\n\n    } catch (error) {\n      console.error(`Failed to read from storage: ${error.message}`)\n      return defaultValue\n    } finally {\n      inflightReads.delete(key)\n    }\n  })()\n\n  inflightReads.set(key, readPromise)\n  return readPromise\n}\n\nasync function writeValue(key, value) {\n  if (typeof window === 'undefined') return\n\n  try {\n    if (key.startsWith('cache:')) {\n      const response = await window.fetch(`/api/storage/setting/${key}`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ value })\n      })\n\n      const data = await response.json()\n      if (!data.success) {\n        throw new Error(data.error || 'Failed to write setting')\n      }\n\n      readCache.set(key, value)\n      emitChange(key)\n      return\n    }\n\n    if (key.startsWith('newsletters:scrapes:')) {\n      const date = key.split(':')[2]\n      const response = await window.fetch(`/api/storage/daily/${date}`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ payload: value })\n      })\n\n      const data = await response.json()\n      if (!data.success) {\n        throw new Error(data.error || 'Failed to write daily cache')\n      }\n\n      readCache.set(key, value)\n      emitChange(key)\n      return\n    }\n\n    throw new Error(`Unknown storage key pattern: ${key}`)\n\n  } catch (error) {\n    console.error(`Failed to persist to storage: ${error.message}`)\n    throw error\n  }\n}\n\nexport function useSupabaseStorage(key, defaultValue) {\n  const [value, setValue] = useState(defaultValue)\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState(null)\n  const valueRef = useRef(defaultValue)\n\n  useEffect(() => {\n    let cancelled = false\n\n    readValue(key, defaultValue).then(loadedValue => {\n      if (!cancelled) {\n        setValue(loadedValue)\n        valueRef.current = loadedValue\n        setLoading(false)\n      }\n    }).catch(err => {\n      if (!cancelled) {\n        console.error(`Failed to load storage value for ${key}:`, err)\n        setError(err)\n        setValue(defaultValue)\n        valueRef.current = defaultValue\n        setLoading(false)\n      }\n    })\n\n    return () => {\n      cancelled = true\n    }\n  }, [key])\n\n  useEffect(() => {\n    const handleChange = () => {\n      readValue(key, defaultValue).then(newValue => {\n        setValue(newValue)\n        valueRef.current = newValue\n      }).catch(err => {\n        console.error(`Failed to reload storage value for ${key}:`, err)\n      })\n    }\n\n    return subscribe(key, handleChange)\n  }, [key])\n\n  const setValueAsync = useCallback(async (nextValue) => {\n    if (typeof window === 'undefined') return\n\n    setLoading(true)\n    setError(null)\n\n    try {\n      const previous = valueRef.current\n      const resolved = typeof nextValue === 'function' ? nextValue(previous) : nextValue\n\n      if (resolved === previous) {\n        setLoading(false)\n        return\n      }\n\n      valueRef.current = resolved\n      await writeValue(key, resolved)\n      setValue(resolved)\n      setLoading(false)\n\n    } catch (err) {\n      console.error(`Failed to set storage value for ${key}:`, err)\n      setError(err)\n      setLoading(false)\n      throw err\n    }\n  }, [key])\n\n  const remove = useCallback(async () => {\n    await setValueAsync(undefined)\n  }, [setValueAsync])\n\n  return [value, setValueAsync, remove, { loading, error }]\n}\n\n</file>\n<file path=\"client/src/index.css\">\n@import \"tailwindcss\";\n@plugin \"@tailwindcss/typography\";\n\n@theme {\n  --font-sans: -apple-system, BlinkMacSystemFont, \"SF Pro Text\", \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n  --font-display: -apple-system, BlinkMacSystemFont, \"SF Pro Display\", \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n\n  --color-brand-50: #f0f9ff;\n  --color-brand-100: #e0f2fe;\n  --color-brand-200: #bae6fd;\n  --color-brand-300: #7dd3fc;\n  --color-brand-400: #38bdf8;\n  --color-brand-500: #0ea5e9;\n  --color-brand-600: #0284c7;\n  --color-brand-700: #0369a1;\n  --color-brand-800: #075985;\n  --color-brand-900: #0c4a6e;\n\n  --shadow-soft: 0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04);\n  --shadow-soft-hover: 0 10px 40px -3px rgba(0, 0, 0, 0.12), 0 4px 15px -2px rgba(0, 0, 0, 0.08);\n}\n\n@layer base {\n  body {\n    @apply bg-slate-50 text-slate-900 antialiased;\n  }\n}\n\n</file>\n<file path=\"client/src/lib/scraper.js\">\n/**\n * Plain JS scraper utilities for React components\n * Extracted from composables/useScraper.js\n */\n\nimport * as storageApi from './storageApi'\nimport { getNewsletterScrapeKey } from './storageKeys'\n\nfunction computeDateRange(startDate, endDate) {\n  const dates = []\n  const start = new Date(startDate)\n  const end = new Date(endDate)\n\n  if (isNaN(start.getTime()) || isNaN(end.getTime())) {\n    return []\n  }\n\n  if (start > end) return []\n\n  const current = new Date(end)\n  while (current >= start) {\n    dates.push(current.toISOString().split('T')[0])\n    current.setDate(current.getDate() - 1)\n  }\n\n  return dates\n}\n\nfunction buildStatsFromPayloads(payloads) {\n  const uniqueUrls = new Set()\n  let totalArticles = 0\n\n  payloads.forEach(payload => {\n    if (payload.articles) {\n      payload.articles.forEach(article => {\n        uniqueUrls.add(article.url)\n        totalArticles++\n      })\n    }\n  })\n\n  return {\n    total_articles: totalArticles,\n    unique_urls: uniqueUrls.size,\n    dates_processed: payloads.length,\n    dates_with_content: payloads.filter(p => p.articles?.length > 0).length\n  }\n}\n\nasync function isRangeCached(startDate, endDate, cacheEnabled) {\n  if (!cacheEnabled) return false\n\n  const dates = computeDateRange(startDate, endDate)\n\n  for (const date of dates) {\n    const isCached = await storageApi.isDateCached(date)\n    if (!isCached) {\n      return false\n    }\n  }\n\n  return true\n}\n\nfunction normalizeIsoDate(value) {\n  if (typeof value !== 'string') return null\n  const trimmed = value.trim()\n  if (!trimmed) return null\n  const date = new Date(trimmed)\n  if (isNaN(date.getTime())) return null\n  return date.toISOString().split('T')[0]\n}\n\nfunction buildDailyPayloadsFromScrape(data) {\n  const payloadByDate = new Map()\n  const issuesByDate = new Map()\n\n  if (Array.isArray(data.issues)) {\n    data.issues.forEach(issue => {\n      const date = normalizeIsoDate(issue.date)\n      if (!date) return\n\n      if (!issuesByDate.has(date)) {\n        issuesByDate.set(date, [])\n      }\n      issuesByDate.get(date).push(issue)\n    })\n  }\n\n  if (Array.isArray(data.articles)) {\n    data.articles.forEach(article => {\n      const date = normalizeIsoDate(article.date)\n      if (!date) return\n\n      const articleData = {\n        url: article.url,\n        title: article.title || article.url,\n        articleMeta: article.article_meta || \"\",\n        issueDate: date,\n        category: article.category || 'Newsletter',\n        sourceId: article.source_id || null,\n        section: article.section_title || null,\n        sectionEmoji: article.section_emoji || null,\n        sectionOrder: article.section_order ?? null,\n        newsletterType: article.newsletter_type || null,\n        removed: Boolean(article.removed),\n        tldrHidden: false,\n        tldr: { status: 'unknown', markdown: '', effort: 'low', checkedAt: null, errorMessage: null },\n        read: { isRead: false, markedAt: null }\n      }\n\n      if (!payloadByDate.has(date)) {\n        payloadByDate.set(date, [])\n      }\n      payloadByDate.get(date).push(articleData)\n    })\n  }\n\n  const payloads = []\n  payloadByDate.forEach((articles, date) => {\n    const issues = issuesByDate.get(date) || []\n    payloads.push({\n      date,\n      cachedAt: new Date().toISOString(),\n      articles,\n      issues\n    })\n  })\n\n  return payloads.sort((a, b) => (a.date < b.date ? 1 : a.date > b.date ? -1 : 0))\n}\n\nasync function mergeWithCache(payloads) {\n  const merged = []\n\n  for (const payload of payloads) {\n    const existing = await storageApi.getDailyPayload(payload.date)\n\n    if (existing) {\n      const mergedPayload = {\n        ...payload,\n        articles: payload.articles.map(article => {\n          const existingArticle = existing.articles?.find(a => a.url === article.url)\n          if (existingArticle) {\n            return {\n              ...article,\n              tldr: existingArticle.tldr || article.tldr,\n              read: existingArticle.read || article.read,\n              removed: existingArticle.removed ?? article.removed,\n              tldrHidden: existingArticle.tldrHidden ?? article.tldrHidden\n            }\n          }\n          return article\n        })\n      }\n\n      await storageApi.setDailyPayload(payload.date, mergedPayload)\n      merged.push(mergedPayload)\n    } else {\n      await storageApi.setDailyPayload(payload.date, payload)\n      merged.push(payload)\n    }\n  }\n\n  return merged\n}\n\nexport async function loadFromCache(startDate, endDate) {\n  const payloads = await storageApi.getDailyPayloadsRange(startDate, endDate)\n\n  if (!payloads || payloads.length === 0) {\n    return null\n  }\n\n  return {\n    success: true,\n    payloads,\n    source: 'local cache',\n    stats: buildStatsFromPayloads(payloads)\n  }\n}\n\nexport async function scrapeNewsletters(startDate, endDate, cacheEnabled = true) {\n  if (await isRangeCached(startDate, endDate, cacheEnabled)) {\n    const cached = await loadFromCache(startDate, endDate)\n    if (cached) {\n      return cached\n    }\n  }\n\n  const response = await window.fetch('/api/scrape', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      start_date: startDate,\n      end_date: endDate\n    })\n  })\n\n  const data = await response.json()\n\n  if (data.success) {\n    const payloads = buildDailyPayloadsFromScrape(data)\n    const mergedPayloads = cacheEnabled ? await mergeWithCache(payloads) : payloads\n\n    return {\n      success: true,\n      payloads: mergedPayloads,\n      source: 'Live scrape',\n      stats: data.stats\n    }\n  } else {\n    throw new Error(data.error || 'Scraping failed')\n  }\n}\n\n</file>\n<file path=\"client/src/lib/storageApi.js\">\nexport async function isDateCached(date) {\n  const response = await window.fetch(`/api/storage/is-cached/${date}`)\n  const data = await response.json()\n\n  if (data.success) {\n    return data.is_cached\n  }\n\n  throw new Error(data.error || 'Failed to check cache')\n}\n\nexport async function getDailyPayload(date) {\n  const response = await window.fetch(`/api/storage/daily/${date}`)\n  const data = await response.json()\n\n  if (data.success) {\n    return data.payload\n  }\n\n  return null\n}\n\nexport async function setDailyPayload(date, payload) {\n  const response = await window.fetch(`/api/storage/daily/${date}`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ payload })\n  })\n\n  const data = await response.json()\n\n  if (!data.success) {\n    throw new Error(data.error || 'Failed to save payload')\n  }\n\n  return data.data\n}\n\nexport async function getDailyPayloadsRange(startDate, endDate) {\n  const response = await window.fetch('/api/storage/daily-range', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ start_date: startDate, end_date: endDate })\n  })\n\n  const data = await response.json()\n\n  if (data.success) {\n    return data.payloads\n  }\n\n  throw new Error(data.error || 'Failed to load payloads')\n}\n\n</file>\n<file path=\"client/src/lib/storageKeys.js\">\nexport const STORAGE_KEYS = {\n  CACHE_ENABLED: 'cache:enabled'\n}\n\n/**\n * Get the storage key for newsletter scrape data for a specific date.\n * @param {string} date - ISO date string (YYYY-MM-DD)\n * @returns {string} The storage key used for Supabase API endpoints\n */\nexport function getNewsletterScrapeKey(date) {\n  return `newsletters:scrapes:${date}`\n}\n\n</file>\n<file path=\"client/src/main.jsx\">\nimport './index.css'\nimport React from 'react'\nimport ReactDOM from 'react-dom/client'\nimport App from './App'\n\nReactDOM.createRoot(document.getElementById('root')).render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>\n)\n\n</file>\n</files>\n",
  "success": true
}
